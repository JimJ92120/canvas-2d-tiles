(()=>{"use strict";var e={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var s={},a=[],o=0;o<e.length;o++){var c=e[o],h=r.base?c[0]+r.base:c[0],l=s[h]||0,d="".concat(h," ").concat(l);s[h]=l+1;var u=n(d),m={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)t[u].references++,t[u].updater(m);else{var p=i(m,r);r.byIndex=o,t.splice(o,0,{identifier:d,updater:p,references:1})}a.push(d)}return a}function i(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var s=r(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var o=n(s[a]);t[o].references--}for(var c=r(e,i),h=0;h<s.length;h++){var l=n(s[h]);0===t[l].references&&(t[l].updater(),t.splice(l,1))}s=c}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},208:(e,t,n)=>{n.d(t,{A:()=>o});var r=n(601),i=n.n(r),s=n(314),a=n.n(s)()(i());a.push([e.id,"body {\n  margin: 0;\n\n  min-height: 100vh;\n  background-color: black;\n  color: white;\n}\n\nbody > * {\n  box-sizing: border-box;\n}\n\n#app {\n  display: flex;\n  flex-flow: column;\n  margin-left: auto;\n  margin-right: auto;\n\n  position: relative;\n  max-width: 500px;\n}\n\n.scene {\n  background-color: lightblue;\n}\n\n.prompt {\n  background-color: white;\n  color: black;\n\n  display: none;\n  position: absolute;\n  bottom: 0;\n  padding: 1rem;\n  width: calc(100% - 2rem);\n  white-space: pre-wrap;\n}\n\n.prompt--active,\n.prompt--active-debug {\n  display: block;\n}\n.prompt * {\n  font-size: 1rem;\n  margin: 0;\n  padding: 0;\n}\n\n/* debug */\n.debug-scene {\n  display: none;\n  background-color: lightgrey;\n  border: 1px solid red;\n}\n.debug-scene--active {\n  display: block;\n}\n\n.app--debug {\n  .prompt--active {\n    bottom: 50%;\n  }\n}\n",""]);const o=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,i,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var h=0;h<e.length;h++){var l=[].concat(e[h]);r&&a[l[0]]||(void 0!==s&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=s),n&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=n):l[2]=n),i&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=i):l[4]="".concat(i)),t.push(l))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,i&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={id:r,exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var i=r.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=r[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),n.nc=void 0;var r=n(72),i=n.n(r),s=n(825),a=n.n(s),o=n(659),c=n.n(o),h=n(56),l=n.n(h),d=n(540),u=n.n(d),m=n(113),p=n.n(m),f=n(208),g={};g.styleTagTransform=p(),g.setAttributes=l(),g.insert=c().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=u(),i()(f.A,g),f.A&&f.A.locals&&f.A.locals;class y{constructor(e){this.$container=e}render(){this.$container.innerHTML='\n      <canvas class="scene"></canvas>\n      <div class="prompt">Hello world</div>\n\n      <canvas class="debug-scene"></canvas>\n  '}}class v{constructor(e,t){this.currentContent=[],this.currentContentIndex=0,this.$container=e,this.activeClassName=t}get isShown(){return this.$container.classList.contains(this.activeClassName)}show(e){e instanceof Array?this.isShown?console.error("prompt is already shown"):(this.currentContent=e,this.showCurrentContent(),this.$container.classList.add(this.activeClassName)):console.error("content is not an array:",e)}hide(){this.currentContentIndex=0,this.currentContent=[],this.$container.innerHTML="",this.$container.classList.remove(this.activeClassName)}next(){return this.isShown?(++this.currentContentIndex,!(this.currentContent.length<=this.currentContentIndex)&&this.showCurrentContent()):(console.error("prompt not shown"),!1)}showCurrentContent(){return this.currentContent[this.currentContentIndex]?(this.$container.innerHTML="",this.$container.textContent=this.currentContent[this.currentContentIndex],!0):(console.error(`current content index ${this.currentContentIndex} not found`),!1)}}var w,b,S,F,R=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};!function(e){e[e.Default=0]="Default",e[e.Raw=1]="Raw",e[e.All=2]="All"}(w||(w={}));class x{constructor(e,t,n){this.assetRecord={},this.$scene=e,this.context=this.$scene.getContext("2d"),this.viewOffset=t,this.options=n}get width(){return this.$scene.width}get height(){return this.$scene.height}getTileSize(e){const{scene:t}=this.options;return t.minimumFrameSize?[t.size[0]/t.minimumFrameSize[0],t.size[1]/t.minimumFrameSize[1]]:[t.size[0]/e[0],t.size[1]/e[1]]}resize(e,t){this.options.scene.minimumFrameSize=[e,t];const n=this.getTileSize([e,t]);this.$scene.width=e*n[0],this.$scene.height=t*n[1]}init(){const{minimumFrameSize:e}=this.options.scene;this.resize(e[0],e[1])}loadAssets(e,t){return R(this,void 0,void 0,(function*(){return yield Promise.all(Object.keys(t).map((n=>this.loadImage(`${e}-${n}`,t[n]))))}))}render(e,t,n,r,i){const{scene:s,mode:a}=this.options;this.context.clearRect(0,0,this.width,this.height);const o=[i[0].length,i.length],c=this.getTileSize(o);s.minimumFrameSize&&(s.minimumFrameSize[0]<o[0]||s.minimumFrameSize[1]<o[1])?this.focus(n,o):0===this.viewOffset[0]&&0===this.viewOffset[1]||(this.viewOffset=[0,0]);const h=[(n[0]-this.viewOffset[0])*c[0],(n[1]-this.viewOffset[1])*c[1]];switch(a){case w.All:this.renderRawData(i,c),this.renderDataWithAssets(e,i,c),this.renderRawCharacter(t,h,r,c),this.renderCharacterWithAssets(t,h,r,c);break;case w.Default:this.renderDataWithAssets(e,i,c),this.renderCharacterWithAssets(t,h,r,c);break;case w.Raw:this.renderRawData(i,c),this.renderRawCharacter(t,h,r,c)}}focus(e,t){const{scene:n}=this.options;if(!n.minimumFrameSize)return;const r=[0==n.minimumFrameSize[0]%2?Math.floor(n.minimumFrameSize[0]/2)-1:Math.floor(n.minimumFrameSize[0]/2),0==n.minimumFrameSize[1]%2?Math.floor(n.minimumFrameSize[1]/2)-1:Math.floor(n.minimumFrameSize[1]/2)];let i=[r[0]>=e[0]?0:e[0]-r[0],r[1]>=e[1]?0:e[1]-r[1]];t[0]<i[0]+n.minimumFrameSize[0]&&(i[0]=t[0]-n.minimumFrameSize[0]),t[1]<i[1]+n.minimumFrameSize[1]&&(i[1]=t[1]-n.minimumFrameSize[1]),this.viewOffset=i}loadImage(e,t){return R(this,void 0,void 0,(function*(){return new Promise((n=>{this.assetRecord[e]=new Image,this.assetRecord[e].src=t,this.assetRecord[e].addEventListener("load",(()=>(console.log(`${e} image loaded`),n(this.assetRecord[e]))))}))}))}renderRawCharacter(e,t,n,r){const{characters:i}=this.options;this.context.fillStyle=i[e].color,this.context.fillRect(t[0],t[1],r[0],r[1]);let s=[t[0],t[1]];switch(n){case"up":s[0]+=r[0]/2;break;case"down":s[0]+=r[0]/2,s[1]+=r[1];break;case"left":s[1]+=r[1]/2;break;case"right":s[0]+=r[0],s[1]+=r[1]/2;break;default:return}this.context.strokeStyle="black",this.context.lineWidth=5,this.context.beginPath(),this.context.moveTo(t[0]+r[0]/2,t[1]+r[1]/2),this.context.lineTo(s[0],s[1]),this.context.stroke()}renderCharacterWithAssets(e,t,n,r){const i=this.assetRecord[`${e}-${n}`];i?this.context.drawImage(i,t[0],t[1],r[0],r[1]):w.Default===this.options.mode&&this.renderRawCharacter(e,t,n,r)}renderRawData(e,t){const{tile:n,scene:r}=this.options;let i=[...e];r.minimumFrameSize&&(i=e.slice(this.viewOffset[1],this.viewOffset[1]+r.minimumFrameSize[1]).map((e=>e.slice(this.viewOffset[0],this.viewOffset[0]+r.minimumFrameSize[0])))),i.map(((e,r)=>{e.map(((e,i)=>{e&&n.colors[e]&&(this.context.fillStyle=n.colors[e],this.context.fillRect(i*t[0],r*t[1],t[0],t[1]))}))}))}renderDataWithAssets(e,t,n){this.assetRecord[`frame-${e}-background`]?this.context.drawImage(this.assetRecord[`frame-${e}-background`],-this.viewOffset[0]*n[0],-this.viewOffset[1]*n[1],t[0].length*n[0],t.length*n[1]):w.Default===this.options.mode&&this.renderRawData(t,n)}}!function(e){e[e.Empty=0]="Empty",e[e.Block=1]="Block",e[e.Building=2]="Building",e[e.Action=3]="Action"}(b||(b={})),function(e){e.Prompt="prompt",e.Load="load"}(S||(S={}));class C{constructor(e,t,n,r){this.data=e,this.actionRecord=t,this.initialPlayerPosition=n,this.assetRecord=r}get width(){return this.data[0].length}get height(){return this.data.length}runAction(e,t){const n=this.getAction(e);n?t(n):console.error(`no action found at [${e}]`)}getAction(e){return this.actionRecord[e.join(":")]||null}}!function(e){e.Up="up",e.Down="down",e.Left="left",e.Right="right"}(F||(F={}));var P=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};class A{constructor(e,t,n,r){this.frameRecord={},this.currentFrameKey="main",this.mapRenderer=null,this.mainFrameLastPosition=[0,0],this.player=e,this.frameRecord=t,this.renderer=new x(n.$scene,n.viewOffset,n.options),n.mapScene&&(this.mapRenderer=new x(n.mapScene.$scene,[0,0],Object.assign(Object.assign({},n.options),{mode:n.mapScene.mode,scene:{size:[...n.options.scene.size],minimumFrameSize:[0,0]}}))),this.prompt=new v(r.$prompt,r.activeClassName)}get isPromptShown(){return this.prompt.isShown}get currentFrame(){return this.frameRecord[this.currentFrameKey]}init(){return P(this,void 0,void 0,(function*(){this.loadFrame("main"),this.renderer.init(),yield this.loadAssets(this.renderer),this.mapRenderer&&(this.mapRenderer.init(),[w.Default,w.All].includes(this.mapRenderer.options.mode)&&(yield this.loadAssets(this.mapRenderer))),this.render()}))}render(){this.renderer.render(this.currentFrameKey,"player",this.player.position,this.player.direction,this.currentFrame.data),this.mapRenderer&&this.mapRenderer.render(this.currentFrameKey,"player",this.player.position,this.player.direction,this.currentFrame.data)}nextOrHidePrompt(){return!!this.prompt.next()||(this.prompt.hide(),!1)}movePlayer(e){this.prompt.hide();const t=this.getDirectionFromKey(e);if(!t)return!1;const n=this.getPlayerPositionFromDirection(t);if(!this.isPositionValid(n))return!1;const r=this.currentFrame.data[n[1]][n[0]];switch(this.player.direction=t,r){case b.Empty:return this.player.position=n,!0;case b.Block:case b.Building:return!1;case b.Action:return this.runFrameAction(n),!0;default:return!1}}loadAssets(e){return P(this,void 0,void 0,(function*(){yield e.loadAssets("player",this.player.assetRecord),yield Promise.all(Object.keys(this.frameRecord).map((t=>e.loadAssets(`frame-${t}`,this.frameRecord[t].assetRecord))))}))}loadFrame(e){if(!this.frameRecord[e])return;const t=this.currentFrameKey;this.currentFrameKey=e,"main"!==this.currentFrameKey||"main"===this.currentFrameKey&&this.currentFrameKey===t?(this.mainFrameLastPosition=this.player.position,this.player.position=this.currentFrame.initialPlayerPosition):this.player.position=this.mainFrameLastPosition,this.mapRenderer&&this.mapRenderer.resize(this.currentFrame.width,this.currentFrame.height)}isPositionValid(e){return 0>e[0]||0>e[1]||this.currentFrame.width<=e[0]||this.currentFrame.height<=e[1]?(console.error(`nextPosition [${e}] is out of bound`),!1):this.currentFrame.data[e[1]]&&!isNaN(Number(this.currentFrame.data[e[1]][e[0]]))}getDirectionFromKey(e){let t=null;switch(e){case"up":t=F.Up;break;case"down":t=F.Down;break;case"left":t=F.Left;break;case"right":t=F.Right}return t}getPlayerPositionFromDirection(e){let t=[...this.player.position];switch(e){case F.Up:--t[1];break;case F.Down:++t[1];break;case F.Left:--t[0];break;case F.Right:++t[0]}return t}runFrameAction(e){this.currentFrame.runAction(e,(e=>{switch(e.type){case S.Prompt:this.prompt.show(e.data);break;case S.Load:this.loadFrame(e.data)}}))}}const $=[10,10],k={DEBUG:!0,MAX_SCENE_SIZE:500,MINIMUM_FRAME_SIZE:$,TILE_SIZE:[500/$[0],500/$[1]],TILE_COLORS:{1:"grey",2:"blue",3:"green"},PLAYER_COLOR:"red"},z=n.p+"assets/map.png",L=new C([[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,1,2,2,2,2,2,2,1,1,1,1,2,2,2,1,1],[1,2,3,2,1,2,2,3,3,2,2,1,1,1,1,2,3,2,1,1],[1,1,0,1,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,1],[1,1,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,1,1,1],[1,1,0,1,1,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1],[1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,1,0,0,0,0,0,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,1,0,0,0,0,0,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,0,0,0,0,0,2,3,2,2,3,2,1],[1,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,1],[1,2,2,3,3,2,2,2,3,2,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,1],[1,1,1,1,0,0,0,0,0,0,0,0,0,2,2,3,3,2,2,1],[1,1,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,2,3,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],{"2:2":{type:S.Prompt,data:["a small building"]},"7:2":{type:S.Prompt,data:["a large building"]},"8:2":{type:S.Prompt,data:["a large building"]},"16:2":{type:S.Prompt,data:["a small building"]},"14:10":{type:S.Prompt,data:["a small building"]},"17:10":{type:S.Prompt,data:["a small building"]},"3:12":{type:S.Prompt,data:["a large building","closed"]},"4:12":{type:S.Prompt,data:["a large building","closed"]},"8:12":{type:S.Prompt,data:["a small building\nclosed"]},"15:14":{type:S.Prompt,data:["a large building"]},"16:14":{type:S.Prompt,data:["a large building"]},"3:16":{type:S.Load,data:"home"}},[3,17],{background:z}),O=new C([[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1],[1,1,1,1,3,1,3,1,1,1],[1,1,2,0,0,0,0,1,1,1],[1,1,3,0,0,0,0,1,1,1],[1,1,2,0,0,0,0,3,1,1],[1,1,1,0,0,0,0,3,1,1],[1,1,1,0,0,0,0,1,1,1],[1,1,1,1,3,3,1,1,1,1],[1,1,1,1,1,1,1,1,1,1]],{"2:4":{type:S.Prompt,data:["desk"]},"4:2":{type:S.Prompt,data:["guitar"]},"6:2":{type:S.Prompt,data:["tinkering"]},"7:5":{type:S.Prompt,data:["shelf"]},"7:6":{type:S.Prompt,data:["moto"]},"4:8":{type:S.Load,data:"main"},"5:8":{type:S.Load,data:"main"}},[4,7],{}),E=n.p+"assets/player-up.png",I=n.p+"assets/player-down.png",D=n.p+"assets/player-left.png",M=n.p+"assets/player-right.png",T=new class{constructor(e,t,n){this.position=e,this.direction=t,this.assetRecord=n}}([0,0],F.Up,{up:E,down:I,left:D,right:M});document.addEventListener("DOMContentLoaded",(()=>{return e=void 0,t=void 0,r=function*(){const e=function(e){const{width:t,height:n}=window.screen;let r=n<=t?n:t;return e<r&&(r=e),r}(k.MAX_SCENE_SIZE),t=new y(document.querySelector("#app"));t.render(),t.$container.style.maxWidth=`${e}px`;let n={$scene:t.$container.querySelector(".scene"),viewOffset:[0,0],options:{mode:w.Default,scene:{size:[e,e],minimumFrameSize:k.MINIMUM_FRAME_SIZE},tile:{colors:k.TILE_COLORS},characters:{player:{color:k.PLAYER_COLOR}}}};const r={$prompt:t.$container.querySelector(".prompt"),activeClassName:"prompt--active"},i={main:L,home:O};k.DEBUG&&(n.mapScene={$scene:t.$container.querySelector(".debug-scene"),mode:w.Raw},n.mapScene.$scene.classList.add("debug-scene--active"),t.$container.classList.add("app--debug"));const s=new A(T,i,n,r);yield s.init(),function(e){document.addEventListener("keyup",(t=>{switch(t.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.movePlayer(t.key.replace("Arrow","").toLowerCase()),e.render();break;case"Escape":case" ":e.nextOrHidePrompt()}}))}(s)},new((n=void 0)||(n=Promise))((function(i,s){function a(e){try{c(r.next(e))}catch(e){s(e)}}function o(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}));var e,t,n,r}))})();